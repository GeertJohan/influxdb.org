<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><title>InfluxDB Underlying Storage and Sharding</title><script src="//fast.fonts.net/jsapi/2de9def5-2dd1-4d89-b4bb-cd7e5f821645.js" type="text/javascript"></script><link href="/stylesheets/all.css" rel="stylesheet" type="text/css" /><script src="/javascripts/all.js" type="text/javascript"></script></head><body class="docs docs_v0"><header class="navigation"><div class="menu-wrapper"><a class="logo" href="/"><img src="/images/influxdb-light400.png" /></a><p class="navigation-menu-button" id="js-mobile-menu">MENU</p><div class="nav"><ul id="navigation-menu"><li class="nav-link"><a href="/docs/v0.8/introduction/overview.html">Overview</a></li><li class="nav-link"><a target="blank" href="https://customers.influxdb.com">Support & Hosting</a></li><li class="nav-link"><a href="/blog">Blog</a></li><li class="nav-link"><a href="/docs/v0.8/introduction/getting_started.html">Docs</a></li><li class="nav-link"><a href="/community">Community</a></li><li class="nav-link"><a target="blank" href="http://play.influxdb.org">Play</a></li></ul></div><div class="navigation-tools"><a class="sign-up" href="/download">Download</a></div></div></header><section role="main"><div class="row"><div class="large-4 medium-4 columns"><div class="sidebar"><nav><ul class="side-nav"><li class="heading">Introduction</li><li><a href="/docs/v0.8/introduction/overview.html">Overview</a></li><li><a href="/docs/v0.8/introduction/installation.html">Installation</a></li><li><a href="/docs/v0.8/introduction/getting_started.html">Getting Started</a></li><li class="divider"></li><li class="heading">API</li><li><a href="/docs/v0.8/api/reading_and_writing_data.html">Reading & Writing Data</a></li><li><a href="/docs/v0.8/api/query_language.html">Query Language</a></li><li><a href="/docs/v0.8/api/aggregate_functions.html">Aggregate Functions</a></li><li><a href="/docs/v0.8/api/continuous_queries.html">Continuous Queries</a></li><li><a href="/docs/v0.8/api/chunked_responses.html">Chunked HTTP Responses</a></li><li><a href="/docs/v0.8/api/administration.html">Administration</a></li><li class="divider"></li><li class="heading">UI</li><li><a href="/docs/v0.8/ui/built_in_admin_and_explorer.html">Built-in Admin and Explorer Interface</a></li><li><a href="/docs/v0.8/ui/grafana.html">Grafana Dashboards</a></li><li><a href="https://github.com/hakobera/influga">Influga Dashboards</a></li><li class="divider"></li><li class="heading">Advanced Topics</li><li><a href="/docs/v0.8/advanced_topics/sharding_and_storage.html">Underlying Storage and Shards</a></li><li><a href="/docs/v0.8/advanced_topics/configuration_options.html">Configuration Options</a></li><li><a href="/docs/v0.8/advanced_topics/schema_design.html">Schema Design</a></li><li><a href="/docs/v0.8/advanced_topics/performance_considerations.html">Performance Considerations</a></li><li><a href="/docs/v0.8/advanced_topics/security.html">Security</a></li><li><a href="/docs/v0.8/advanced_topics/upgrading.html">Upgrading from Previous Versions</a></li><li class="divider"></li><li class="heading">Clustering</li><li><a href="/docs/v0.8/clustering/design.html">Design</a></li><li><a href="/docs/v0.8/clustering/setup.html">Setup</a></li><li class="divider"></li><li class="heading">Guides</li><li><a href="/docs/v0.8/guides/intro.html">Introduction</a></li><li><a href="/docs/v0.8/guides/replacing_graphite.html">Replacing Graphite</a></li><li><a href="http://www.fluentd.org/guides/recipes/syslog-influxdb">Syslog Analytics with FluentD</a></li><li class="divider"></li><li class="heading">Future Features</li><li><a href="/docs/v0.8/future/binary_protocol.html">Binary Protocol</a></li><li><a href="/docs/v0.8/future/pubsub.html">Pubsub</a></li><li><a href="/docs/v0.8/future/column_indexes.html">Column Indexes and Tags</a></li><li><a href="/docs/v0.8/future/custom_functions.html">Custom Functions</a></li><li><a href="/docs/v0.8/future/security.html">Security Enhancements</a></li><li><a href="/docs/v0.8/future/merge.html">Merging Many Series</a></li><li class="divider"></li><li class="heading">Client Libraries</li><li><a href="/docs/v0.8/client_libraries/javascript.html">JavaScript</a></li><li><a href="https://github.com/influxdb/influxdb-ruby">Ruby</a></li><li><a href="https://github.com/influxdb/influxdb-rails">Rails</a></li><li><a href="/docs/v0.8/client_libraries/python.html">Python</a></li><li><a href="https://github.com/puentesarrin/asyncflux">Python (async Tornado)</a></li><li><a href="/docs/v0.8/client_libraries/node.html">Node.js</a></li><li><a href="/docs/v0.8/client_libraries/php.html">PHP</a></li><li><a href="https://github.com/influxdb/influxdb-java">Java</a></li><li><a href="https://github.com/olauzon/capacitor">Clojure</a></li><li><a href="https://github.com/mmaul/cl-influxdb">Common Lisp</a></li><li><a href="https://github.com/davidB/metrics-influxdb">Java Metrics</a></li><li><a href="https://github.com/influxdb/influxdb-go">Go</a></li><li><a href="https://github.com/rcrowley/go-metrics">Go Metrics</a></li><li><a href="https://github.com/influxdb/influxdb-scala">Scala</a></li><li><a href="https://github.com/influxdb/influxdb-r">R</a></li><li><a href="https://github.com/radekg/erflux">Erlang</a></li><li><a href="https://metacpan.org/pod/InfluxDB">Perl</a></li><li><a href="https://github.com/maoe/influxdb-haskell">Haskell</a></li><li><a href="https://github.com/ziyasal/InfluxDB.Net">.NET (C#)</a></li><li class="divider"></li><li class="heading">Contributing</li><li><a href="https://github.com/influxdb/influxdb/blob/master/docs/contributing.md">Building and Contributing</a></li><li><a href="/community/cla.html">CLA</a></li><li><a href="https://github.com/influxdb/influxdb.org">To this Documentation</a></li><li><a href="https://github.com/influxdb/influxdb/blob/master/LICENSE">License (MIT)</a></li><li class="divider"></li><li class="heading">Other Libraries and Tools</li><li><a href="https://github.com/Dieterbe/influx-cli">CLI (Go)</a></li><li><a href="https://github.com/FGRibreau/influxdb-cli">CLI (Node)</a></li><li><a href="https://github.com/phstc/influxdb-cli">CLI (Ruby)</a></li><li><a href="http://grafana.org/">Grafana (dashboards)</a></li><li><a href="https://github.com/vimeo/graphite-influxdb">Graphite-Influxdb bridge</a></li><li><a href="https://github.com/obfuscurity/tasseo">Tasseo (realtime dashboard)</a></li><li><a href="https://github.com/bernd/statsd-influxdb-backend">StatsD Backend</a></li><li><a href="https://github.com/bpaquet/collectd-influxdb-proxy">CollectD Proxy</a></li><li><a href="https://github.com/fangli/fluent-plugin-influxdb">FluentD Plugin</a></li><li><a href="https://github.com/lusis/sensu_influxdb_handler">Sensu Handler</a></li><li><a href="https://github.com/SimpleFinance/chef-handler-influxdb">Chef Handler/Reporter</a></li><li><a href="https://github.com/CargoSense/puppet-influxdb">Config Management via Boxen</a></li><li><a href="https://github.com/savoirfairelinux/mod-influxdb">Shinken module</a></li><li><a href="https://github.com/ezotrank/logsend">LogSend</a></li><li class="divider"></li><li class="heading">Docs Versions</li><li><a href="/docs/v0.6/introduction/overview.html">v0.6</a></li><li><a href="/docs/v0.7/introduction/overview.html">v0.7</a></li><li><a href="/docs/v0.8/introduction/overview.html">v0.8</a></li></ul></nav><a class="button download expand" href="/download" style="margin-bottom: 0;">Download InfluxDB</a></div></div><div class="large-8 medium-8 columns" id="docs"><h1 id="storage-engines">Storage Engines</h1>

<p>InfluxDB can use different storage engines for the underlying storage of data. The current options are LevelDB, RocksDB, HyperLevelDB, and LMDB. The first three are Log Structured Merge Trees with Rocks and Hyper being forks of LevelDB. LMDB is a memory-mapped Copy on Write B+Tree. We&rsquo;ve performed some <a href="http://influxdb.com/blog/2014/06/20/leveldb_vs_rocksdb_vs_hyperleveldb_vs_lmdb_performance.html">initial testing on the different storage engines</a>. RocksDB seems to come out on top so we&rsquo;ve made it the default. See the configuration file for more information about <a href="https://github.com/influxdb/influxdb/blob/master/config.sample.toml#L83">configuring the different storage engines</a>.</p>

<h1 id="databases-and-shard-spaces">Databases and Shard Spaces</h1>

<p>Data in InfluxDB is organized into <strong>databases</strong> which have many <strong>shard spaces</strong> which have many <strong>shards</strong>. A shard maps to an underlying storage engine database. That is, each shard will be a separate LevelDB or LMDB. The implications of this are that if you want to keep your underlying storage engine databases small, configure things so your data will be split across many shards.</p>

<p>Shard spaces have the following properties:</p>
<pre class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high_precision"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"database"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pauls_db"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"retentionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7d"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"shardDuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1d"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/^[a-z].*/"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"replicationFactor"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"split"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre>

<p>You can see that a shard space belongs to a specific database. The <code>retentionPolicy</code> is the period of time that data will be kept around. The exact semantics are that data is kept <strong>at least</strong> that long. The amount of time it is kept after that is determined by the <code>shardDuration</code>.</p>

<p>Shard duration should be something that is quite a bit less than the retention policy, but at least as big as the value you do <code>group by time()</code> queries on. Shards that are expired will be cleared from Influx automatically. In the example shard space above, you&rsquo;d always have 7-8 days worth of data. A shard would get cleared once its <code>endTime</code> was past 7 days ago.</p>

<p>The <code>replicationFactor</code> setting tells the InfluxDB cluster how many servers should have a copy of each shard in the given shard space. Finally, <code>split</code> tells the cluster how many shards to create for a given interval of time. Data for that interval will be distributed across the shards. This setting is how you achieve write scalability. You may want to have <code>replicationFactor * split == number of servers</code>. That will ensure that every server in the cluster will be hot for writes at any given time.</p>

<p>Data is assigned to a shard using the following algorithm:</p>

<ul>
<li>Look up the shard spaces for the InfluxDB database</li>
<li>Loop through the spaces and use the first one that matches the series name</li>
<li>Lookup the shards for the given time interval</li>
<li>If no shards exist, create N shards for the interval based on <code>split</code></li>
<li>Assign the data to a given shard in the interval using the algorithm <br /><code>hash(series_name) % N</code></li>
</ul>

<p>The best way to use shard spaces is to have high precision data write into a shard space with a lower retention policy. Then have continuous queries downsample from that data into new series that start with their interval (like <code>1h</code> or <code>10m</code>). Create a shard space that will match against those series names.</p>

<p>Dropping shard, shard spaces, and databases are very efficient operations. If you&rsquo;re going to be cleaning out certain data regularly, it&rsquo;s best to use the shard spaces feature to organize things so that it&rsquo;s efficient.</p>

<p>Note that a duration of <code>inf</code> or an empty string will cause the shards in that space to never be automatically dropped. If you create a database and start writing data in, the following shard space will be created automatically:</p>
<pre class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"database"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pauls_db"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"retentionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"inf"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"shardDuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7d"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/.*/"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"replicationFactor"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"split"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre>

<h1 id="configuration">Configuration</h1>

<p>You must set up shard spaces when you create your database. You can also set up any continuous queries you want running at the same time. It&rsquo;s easy to do through the API. Take a file like this:</p>
<pre class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="s2">"spaces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"everything_30d"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"retentionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"30d"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"shardDuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7d"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/.*/"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"replicationFactor"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="s2">"split"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"forever"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"retentionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"inf"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"shardDuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7d"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/^_.*/"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"replicationFactor"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="s2">"split"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rollups"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"retentionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"365d"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"shardDuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"30d"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/^\\d+.*/"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"replicationFactor"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="s2">"split"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"continuousQueries"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"select * from events into events.[id]"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"select count(value) from events group by time(5m) into 5m.count.events"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre>

<p>Note that shard spaces should be ordered in the file from least specific to most. If you have a generic catch all shard space, it should be listed as the first one.</p>

<p>Create the database, shard spaces, and continuous queries with this call:</p>
<pre class="highlight plaintext">curl -X POST \
  "http://localhost:8086/cluster/database_configs/mydb?u=root&amp;p=root" \
  --data-binary @myconfig.json
</pre>

<p>There you&rsquo;re creating a database called <code>mydb</code> and loading it with the shard space and continuous query config from the local file <code>myconfig.json</code>.</p>

<p>You can only run this command once when initially creating the database. It will error out if the database already exists. Later on we&rsquo;ll have tools for working with existing databases.</p>

<h1 id="updating-shard-spaces">Updating Shard Spaces</h1>

<p>As of version 0.8.2 you can update shard space definitions. However, it&rsquo;s important to note that updates do not move things around. The updates to replication factor and split will only cause future shards to have those changes. If you update the regex, you could end up hiding a bunch of data that was previously accessible.</p>

<p>So be very careful when using this feature. If you don&rsquo;t fully understand shard spaces and how things work, it&rsquo;s best to avoid this one.</p>

<p>The API endpoint is: <code>/cluster/shard_spaces/:db/:name</code>. Where :db is the database name and :name is the shard space name. You can post JSON that looks like this:</p>
<pre class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="s2">"retentionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"365d"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"shardDuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"30d"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/^\\d+.*/"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"replicationFactor"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"split"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre>

<p>Updates to the retention policy will take effect on the next sweep, which happens every 10 minutes. Updates to replication factor and split will be take into account the next time shards must be created for a shard space. Regex updates will take effect for any writes after the update and for any queries.</p>
</div></div></section><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-45024174-1', 'influxdb.com');
ga('send', 'pageview');</script><script type="text/javascript">(function() {
  $("#docs h1, #docs h2, #docs h3, #docs h4").each(function(i, el) {
    var id, text;
    id = el.id;
    text = $(el).text();
    return $(el).html('<a href="#' + id + '">' + text + '</a>');
  });

}).call(this);
</script></body></html>